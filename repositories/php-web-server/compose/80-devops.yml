version: "2"
services:
  cgi_server:
    depends_on:
    - mailhog

  task_scheduler:
    depends_on:
    - mailhog

  example_worker:
    depends_on:
    - mailhog

  mailhog:
    image: mailhog/mailhog:latest
    entrypoint: >
      sh -c "
        echo \"${BACKING_SERVICES_USER}:$$(MailHog bcrypt '${MAILHOG_PASSWORD}')\" > /home/mailhog/htpasswd;
        MailHog -auth-file=/home/mailhog/htpasswd
      "
    restart: on-failure
    ports:
    - ${MAILHOG_PORT}:8025

  minio:
    ports:
    - ${MINIO_PORT}:9000

  minio_constructor:
    depends_on:
    - minio
    image: minio/mc:latest
    entrypoint: >
      sh -c "
        /usr/bin/mc config host add myminioserver http://minio:9000 '${BACKING_SERVICES_USER}' '${MINIO_PASSWORD}';
        /usr/bin/mc mb myminioserver/myminiobucket;
        /usr/bin/mc policy download myminioserver/myminiobucket;
        exit 0
      "
    restart: on-failure

  mysql:
    ports:
    - ${MYSQL_PORT}:3306

  phpmyadmin:
    depends_on:
    - mysql
    image: phpmyadmin/phpmyadmin:latest
    restart: on-failure
    environment:
    - PMA_HOST=mysql
    - PMA_PORT=3306
    ports:
    - ${PHPMYADMIN_PORT}:80

  rabbitmq:
    image: rabbitmq:management
    ports:
    - ${RABBITMQ_MANAGEMENT_PORT}:15672

  redis_commander:
    depends_on:
    - redis
    image: rediscommander/redis-commander:latest
    restart: on-failure
    environment:
    - HTTP_USER=${BACKING_SERVICES_USER}
    - HTTP_PASSWORD=${REDIS_PASSWORD}
    - REDIS_HOSTS=session:redis:6379:0:${REDIS_PASSWORD},cache:redis:6379:1:${REDIS_PASSWORD}
    ports:
    - ${REDIS_COMMANDER_PORT}:8081
